<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.library.dao.BorrowRecordMapper">

    <resultMap id="BorrowRecordResultMap" type="BorrowRecord">
        <id property="recordId" column="record_id"/>
        <result property="bookId" column="book_id"/>
        <result property="readerId" column="reader_id"/>
        <result property="borrowDate" column="borrow_date"/>
        <result property="dueDate" column="due_date"/>
        <result property="returnDate" column="return_date"/>
        <result property="status" column="status"/>
        <result property="remark" column="remark"/>
        <result property="createTime" column="create_time"/>
    </resultMap>

    <resultMap id="BorrowRecordDetailMap" type="BorrowRecord" extends="BorrowRecordResultMap">
        <association property="book" javaType="Book">
            <id property="bookId" column="book_id"/>
            <result property="isbn" column="isbn"/>
            <result property="title" column="title"/>
            <result property="author" column="author"/>
        </association>
        <association property="reader" javaType="Reader">
            <id property="readerId" column="reader_id"/>
            <result property="studentNo" column="student_no"/>
            <result property="name" column="reader_name"/>
        </association>
    </resultMap>

    <select id="selectById" resultMap="BorrowRecordResultMap">
        SELECT * FROM borrow_record WHERE record_id = #{recordId}
    </select>

    <select id="selectAll" resultMap="BorrowRecordResultMap">
        SELECT * FROM borrow_record ORDER BY record_id
    </select>

    <select id="selectByReaderId" resultMap="BorrowRecordResultMap">
        SELECT * FROM borrow_record WHERE reader_id = #{readerId} ORDER BY borrow_date DESC
    </select>

    <select id="selectByBookId" resultMap="BorrowRecordResultMap">
        SELECT * FROM borrow_record WHERE book_id = #{bookId} ORDER BY borrow_date DESC
    </select>

    <select id="selectByCondition" resultMap="BorrowRecordResultMap">
        SELECT * FROM borrow_record
        <where>
            <if test="readerId != null">
                AND reader_id = #{readerId}
            </if>
            <if test="bookId != null">
                AND book_id = #{bookId}
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
        </where>
        ORDER BY borrow_date DESC
    </select>

    <select id="selectWithDetails" resultMap="BorrowRecordDetailMap">
        SELECT 
            br.*,
            b.isbn,
            b.title,
            b.author,
            r.student_no,
            r.name as reader_name
        FROM borrow_record br
        LEFT JOIN book b ON br.book_id = b.book_id
        LEFT JOIN reader r ON br.reader_id = r.reader_id
        ORDER BY br.borrow_date DESC
    </select>

    <select id="selectByReaderIdWithDetails" resultMap="BorrowRecordDetailMap">
        SELECT 
            br.*,
            b.isbn,
            b.title,
            b.author,
            r.student_no,
            r.name as reader_name
        FROM borrow_record br
        LEFT JOIN book b ON br.book_id = b.book_id
        LEFT JOIN reader r ON br.reader_id = r.reader_id
        WHERE br.reader_id = #{readerId}
        ORDER BY br.borrow_date DESC
    </select>

    <insert id="insert" parameterType="BorrowRecord" useGeneratedKeys="true" keyProperty="recordId">
        INSERT INTO borrow_record (book_id, reader_id, borrow_date, due_date, return_date, status, remark)
        VALUES (#{bookId}, #{readerId}, #{borrowDate}, #{dueDate}, #{returnDate}, #{status}, #{remark})
    </insert>

    <update id="update" parameterType="BorrowRecord">
        UPDATE borrow_record
        <set>
            <if test="bookId != null">book_id = #{bookId},</if>
            <if test="readerId != null">reader_id = #{readerId},</if>
            <if test="borrowDate != null">borrow_date = #{borrowDate},</if>
            <if test="dueDate != null">due_date = #{dueDate},</if>
            <if test="returnDate != null">return_date = #{returnDate},</if>
            <if test="status != null">status = #{status},</if>
            <if test="remark != null and remark != ''">remark = #{remark},</if>
        </set>
        WHERE record_id = #{recordId}
    </update>

    <delete id="deleteById">
        DELETE FROM borrow_record WHERE record_id = #{recordId}
    </delete>

    <select id="countByReaderId" resultType="int">
        SELECT COUNT(*) FROM borrow_record 
        WHERE reader_id = #{readerId}
        <if test="status != null">
            AND status = #{status}
        </if>
    </select>

</mapper>
